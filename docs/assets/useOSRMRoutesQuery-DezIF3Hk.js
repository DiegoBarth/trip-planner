import{K as e,O as t}from"./index-DI6Nv9be.js";async function n(e){if(e.length<2)return null;try{let t=`https://router.project-osrm.org/route/v1/walking/${e.map(e=>`${e.lng},${e.lat}`).join(`;`)}?overview=full&geometries=geojson`,n=new AbortController,r=setTimeout(()=>n.abort(),15e3),i=await fetch(t,{signal:n.signal});if(clearTimeout(r),!i.ok)return console.warn(`OSRM response not ok`),null;let a=await i.json();if(!a.routes||!a.routes.length)return null;let o=a.routes[0];return{path:o.geometry?.coordinates?.map(([e,t])=>[t,e])??[],distanceKm:o.distance/1e3,legs:o.legs?.map(e=>({distanceKm:e.distance/1e3,durationMinutes:Math.ceil(e.duration/60)}))}}catch{return console.warn(`OSRM unavailable. Showing only markers.`),null}}function r(e,t){let n=e.length,r=Array(n-1),i=e.map((e,t)=>({a:e,i:t})).filter(({a:e})=>e.lat!=null&&e.lng!=null);if(i.length<2||t.length===0)return r.fill(null);for(let a=0;a<n-1;a++){let n=e[a],o=e[a+1];if(!n.lat||!n.lng||!o.lat||!o.lng){r[a]=null;continue}let s=i.findIndex(e=>e.i===a);if(s<0||s+1>=i.length||i[s+1].i!==a+1||!t[s]){r[a]=null;continue}let c=t[s],l=c.distanceKm>3?`transit`:`walking`,u=l===`walking`?Math.ceil(c.distanceKm/5*60):c.durationMinutes;r[a]={from:n,to:o,distanceKm:c.distanceKm,durationMinutes:u,travelMode:l}}return r}async function i(e){let t=e.length,r=Array(t-1),i=e.map((e,t)=>({a:e,i:t})).filter(({a:e})=>e.lat!=null&&e.lng!=null),a=i.map(({a:e})=>({lat:e.lat,lng:e.lng}));if(a.length<2)return r.fill(null);let o=await n(a);if(!o?.legs||o.legs.length===0)return r.fill(null);let s=o.legs;for(let n=0;n<t-1;n++){let t=e[n],a=e[n+1];if(!t.lat||!t.lng||!a.lat||!a.lng){r[n]=null;continue}let o=i.findIndex(e=>e.i===n);if(o<0||o+1>=i.length||i[o+1].i!==n+1){r[n]=null;continue}let c=s[o],l=c.distanceKm>3?`transit`:`walking`,u=l===`walking`?Math.ceil(c.distanceKm/5*60):c.durationMinutes;r[n]={from:t,to:a,distanceKm:c.distanceKm,durationMinutes:u,travelMode:l}}return r}function a(e){let[t,n]=e.split(`:`).map(Number);return t*60+n}function o(e){let t=Math.floor(e/60),n=e%60;return`${t.toString().padStart(2,`0`)}:${n.toString().padStart(2,`0`)}`}function s(e){return e.duration===0?0:e.duration||60}function c(e,t){let n=[],r=a(`09:00`);for(let i=0;i<e.length;i++){let c=e[i],l=i>0?t[i-1]:null;l&&(r+=l.durationMinutes);let u=r,d=o(u),f=s(c),p=r+f,m=o(p);if(c.openingTime&&c.closingTime){let e=a(c.openingTime),t=a(c.closingTime);u<e&&(n.push({attractionId:c.id,type:`late-arrival`,message:`Chegada às ${d}, mas abre às ${c.openingTime}`,severity:`warning`}),r=e),u>=t?n.push({attractionId:c.id,type:`closed`,message:`Chegada às ${d}, mas fecha às ${c.closingTime}`,severity:`error`}):p>t&&n.push({attractionId:c.id,type:`overlap`,message:`Saída prevista ${m}, mas fecha às ${c.closingTime}`,severity:`warning`})}r>a(`21:00`)&&n.push({attractionId:c.id,type:`rush`,message:`Dia muito extenso - chegada prevista às ${d}`,severity:`warning`}),r=p}return n}async function l(e,t){if(e.length===0)return null;let n=[...e].sort((e,t)=>e.order-t.order),r=t!=null&&t.length===n.length-1?t:await i(n),l=r.reduce((e,t)=>e+(t?.distanceKm??0),0),u=r.reduce((e,t)=>e+(t?.durationMinutes??0),0),d=c(n,r),f=`09:00`,p=a(f),m=[],h=[];for(let e=0;e<n.length;e++){if(e===0)m.push(o(p));else{let t=h[e-1]?a(h[e-1]):p,n=r[e-1]?.durationMinutes||0;m.push(o(t+n)),p=t+n}let t=s(n[e]);h.push(o(p+t)),p+=t}let g=h[h.length-1]||f,_=n.map((e,t)=>({...e,arrivalTime:m[t],departureTime:h[t]}));return{date:n[0].date,dayNumber:n[0].day,attractions:_,segments:r,conflicts:d,totalDistance:l,totalTravelTime:u,startTime:f,endTime:g}}function u(e){return typeof e.lat==`number`&&typeof e.lng==`number`}function d(e,t){return{id:-999,name:e.description,lat:e.lat,lng:e.lng,city:e.city,region:t.region,country:e.country,order:0,date:t.date,day:t.day,dayOfWeek:t.dayOfWeek,type:`other`,duration:0,couplePrice:0,priceInBRL:0,currency:t.currency,visited:!1,needsReservation:!1,openingTime:void 0,closingTime:void 0,imageUrl:void 0}}async function f(e,t){let i={},a={},o={};for(let[s,c]of Object.entries(e)){let e=c.filter(u);if(e.length<2)continue;let l=[...e].sort((e,t)=>e.order-t.order),f=l.map(e=>({lat:e.lat,lng:e.lng}));if(t.length>0){let e=t[0];f=[{lat:e.lat,lng:e.lng},...f,{lat:e.lat,lng:e.lng}]}let p=await n(f);if(!p)continue;let m=Number(s);if(i[m]=p.path,a[m]=p.distanceKm,p.legs&&p.legs.length>=l.length){let e=p.legs.slice(0,l.length);o[m]=r(t.length>0&&l[0]?[d(t[0],l[0]),...l]:l,e)}else{let e=t.length>0&&l.length>0?l.length:Math.max(0,l.length-1);o[m]=Array(e).fill(null)}}return{routes:i,distances:a,segmentsByDay:o}}function p(e,t){return`${Object.keys(e).map(t=>`${t}:${e[Number(t)].map(e=>`${e.id}-${e.lat}-${e.lng}-${e.order}`).join(`,`)}`).sort().join(`|`)};${t.length?t.map(e=>`${e.id}-${e.lat}-${e.lng}`).join(`,`):``}`}function m(n,r){let i=p(n,r),a=Object.keys(n).length>0,o=t({queryKey:[`osrm-routes`,i],queryFn:()=>f(n,r),staleTime:e,enabled:a}),s=o.data;return{routes:s?.routes??{},distances:s?.distances??{},segmentsByDay:s?.segmentsByDay??{},isRoutesLoading:o.isLoading,refetch:o.refetch}}export{u as n,l as r,m as t};