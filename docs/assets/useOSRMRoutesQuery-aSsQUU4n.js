import{p as e}from"./google-login-button-CK2bO50y.js";import{i as t}from"./react-query-BB-sDLdC.js";import{a as n}from"./index-CIXHJ0H9.js";function r(){let{data:e=[],isLoading:r,error:i}=t(n());return{accommodations:e,isLoading:r,error:i}}async function i(e){if(e.length<2)return null;try{let t=`https://router.project-osrm.org/route/v1/walking/${e.map(e=>`${e.lng},${e.lat}`).join(`;`)}?overview=full&geometries=geojson`,n=new AbortController,r=setTimeout(()=>n.abort(),15e3),i=await fetch(t,{signal:n.signal});if(clearTimeout(r),!i.ok)return console.warn(`OSRM response not ok`),null;let a=await i.json();if(!a.routes||!a.routes.length)return null;let o=a.routes[0];return{path:o.geometry?.coordinates?.map(([e,t])=>[t,e])??[],distanceKm:o.distance/1e3,legs:o.legs?.map(e=>({distanceKm:e.distance/1e3,durationMinutes:Math.ceil(e.duration/60)}))}}catch{return console.warn(`OSRM unavailable. Showing only markers.`),null}}function a(e,t){let n=e.length,r=Array(n-1),i=e.map((e,t)=>({a:e,i:t})).filter(({a:e})=>e.lat!=null&&e.lng!=null);if(i.length<2||t.length===0)return r.fill(null);for(let a=0;a<n-1;a++){let n=e[a],o=e[a+1];if(!n.lat||!n.lng||!o.lat||!o.lng){r[a]=null;continue}let s=i.findIndex(e=>e.i===a);if(s<0||s+1>=i.length||i[s+1].i!==a+1||!t[s]){r[a]=null;continue}let c=t[s],l=c.distanceKm>3?`transit`:`walking`,u=l===`walking`?Math.ceil(c.distanceKm/5*60):c.durationMinutes;r[a]={from:n,to:o,distanceKm:c.distanceKm,durationMinutes:u,travelMode:l}}return r}async function o(e){let t=e.length,n=Array(t-1),r=e.map((e,t)=>({a:e,i:t})).filter(({a:e})=>e.lat!=null&&e.lng!=null),a=r.map(({a:e})=>({lat:e.lat,lng:e.lng}));if(a.length<2)return n.fill(null);let o=await i(a);if(!o?.legs||o.legs.length===0)return n.fill(null);let s=o.legs;for(let i=0;i<t-1;i++){let t=e[i],a=e[i+1];if(!t.lat||!t.lng||!a.lat||!a.lng){n[i]=null;continue}let o=r.findIndex(e=>e.i===i);if(o<0||o+1>=r.length||r[o+1].i!==i+1){n[i]=null;continue}let c=s[o],l=c.distanceKm>3?`transit`:`walking`,u=l===`walking`?Math.ceil(c.distanceKm/5*60):c.durationMinutes;n[i]={from:t,to:a,distanceKm:c.distanceKm,durationMinutes:u,travelMode:l}}return n}function s(e){let[t,n]=e.split(`:`).map(Number);return t*60+n}function c(e){let t=Math.floor(e/60),n=e%60;return`${t.toString().padStart(2,`0`)}:${n.toString().padStart(2,`0`)}`}function l(e){return e.duration===0?0:e.duration||60}function u(e,t){let n=[],r=s(`09:00`);for(let i=0;i<e.length;i++){let a=e[i],o=i>0?t[i-1]:null;o&&(r+=o.durationMinutes);let u=r,d=c(u),f=l(a),p=r+f,m=c(p);if(a.openingTime&&a.closingTime){let e=s(a.openingTime),t=s(a.closingTime);u<e&&(n.push({attractionId:a.id,type:`late-arrival`,message:`Chegada às ${d}, mas abre às ${a.openingTime}`,severity:`warning`}),r=e),u>=t?n.push({attractionId:a.id,type:`closed`,message:`Chegada às ${d}, mas fecha às ${a.closingTime}`,severity:`error`}):p>t&&n.push({attractionId:a.id,type:`overlap`,message:`Saída prevista ${m}, mas fecha às ${a.closingTime}`,severity:`warning`})}r>s(`21:00`)&&n.push({attractionId:a.id,type:`rush`,message:`Dia muito extenso - chegada prevista às ${d}`,severity:`warning`}),r=p}return n}async function d(e,t){if(e.length===0)return null;let n=[...e].sort((e,t)=>e.order-t.order),r=t!=null&&t.length===n.length-1?t:await o(n),i=r.reduce((e,t)=>e+(t?.distanceKm??0),0),a=r.reduce((e,t)=>e+(t?.durationMinutes??0),0),d=u(n,r),f=`09:00`,p=s(f),m=[],h=[];for(let e=0;e<n.length;e++){if(e===0)m.push(c(p));else{let t=h[e-1]?s(h[e-1]):p,n=r[e-1]?.durationMinutes||0;m.push(c(t+n)),p=t+n}let t=l(n[e]);h.push(c(p+t)),p+=t}let g=h[h.length-1]||f,_=n.map((e,t)=>({...e,arrivalTime:m[t],departureTime:h[t]}));return{date:n[0].date,dayNumber:n[0].day,attractions:_,segments:r,conflicts:d,totalDistance:i,totalTravelTime:a,startTime:f,endTime:g}}function f(e){return typeof e.lat==`number`&&typeof e.lng==`number`}function p(e,t){return{id:-999,name:e.description,lat:e.lat,lng:e.lng,city:e.city,region:t.region,country:e.country,order:0,date:t.date,day:t.day,dayOfWeek:t.dayOfWeek,type:`other`,duration:0,couplePrice:0,priceInBRL:0,currency:t.currency,visited:!1,needsReservation:!1,openingTime:void 0,closingTime:void 0,imageUrl:void 0}}async function m(e,t){let n={},r={},o={};for(let[s,c]of Object.entries(e)){let e=c.filter(f);if(e.length<2)continue;let l=[...e].sort((e,t)=>e.order-t.order),u=l.map(e=>({lat:e.lat,lng:e.lng}));if(t.length>0){let e=t[0];u=[{lat:e.lat,lng:e.lng},...u,{lat:e.lat,lng:e.lng}]}let d=await i(u);if(!d)continue;let m=Number(s);if(n[m]=d.path,r[m]=d.distanceKm,d.legs&&d.legs.length>=l.length){let e=d.legs.slice(0,l.length);o[m]=a(t.length>0&&l[0]?[p(t[0],l[0]),...l]:l,e)}else{let e=t.length>0&&l.length>0?l.length:Math.max(0,l.length-1);o[m]=Array(e).fill(null)}}return{routes:n,distances:r,segmentsByDay:o}}function h(e,t){return`${Object.keys(e).map(t=>`${t}:${e[Number(t)].map(e=>`${e.id}-${e.lat}-${e.lng}-${e.order}`).join(`,`)}`).sort().join(`|`)};${t.length?t.map(e=>`${e.id}-${e.lat}-${e.lng}`).join(`,`):``}`}function g(n,r){let i=h(n,r),a=Object.keys(n).length>0,o=t({queryKey:[`osrm-routes`,i],queryFn:()=>m(n,r),staleTime:e,enabled:a}),s=o.data;return{routes:s?.routes??{},distances:s?.distances??{},segmentsByDay:s?.segmentsByDay??{},isRoutesLoading:o.isLoading,refetch:o.refetch}}export{r as i,f as n,d as r,g as t};