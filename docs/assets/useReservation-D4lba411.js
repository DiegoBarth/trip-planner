import{p as e}from"./google-login-button-DJk_bU6U.js";import{i as t,o as n,t as r}from"./react-query-B2gPi3Dv.js";import{C as i,D as a,E as o,H as s,N as c,O as l,S as u,T as d,U as f,b as p,w as m,x as h}from"./index-C_ascuSl.js";var g=[`reservations`];function _(){let _=n(),{data:v=[],isLoading:y,error:b}=t({queryKey:g,queryFn:a,staleTime:e}),x=r({mutationFn:e=>m(e),onSuccess:e=>{p(_,e)}}),S=r({mutationFn:async e=>{let t=v.find(t=>t.id===e.id);if(t?.documentFileId&&t.documentFileId!==e.documentFileId)try{await d(t.documentFileId)}catch(e){console.error(`Error deleting old file from Drive:`,e)}e.date=e.date?c(e.date):void 0,e.endDate=e.endDate?c(e.endDate):void 0;let n=await l(e);if(n.attractionId&&n.status)try{let e=[`japan`,`south-korea`,`general`],t=null,r=null;for(let i of e){let e=_.getQueryData([`attractions`,i]);if(e){let a=e.find(e=>e.id===n.attractionId);if(a){t=a,r=i;break}}}if(t&&r){let e;n.status===`confirmed`?e=`confirmed`:n.status===`pending`?e=`pending`:n.status===`cancelled`&&(e=`cancelled`),e&&(await f({...t,date:c(t.date),reservationStatus:e}),_.setQueryData([`attractions`,r],(n=[])=>n.map(n=>n.id===t.id?{...n,reservationStatus:e}:n)))}}catch(e){console.error(`Error syncing status with linked attraction:`,e)}return n},onSuccess:e=>{u(_,e)}}),C=r({mutationFn:async e=>{let t=v.find(t=>t.id===e);if(t?.documentFileId)try{await d(t.documentFileId)}catch(e){console.error(`Error deleting file from Drive:`,e)}if(t?.attractionId)try{await s(t.attractionId);for(let e of[`japan`,`south-korea`,`general`])if(_.getQueryData([`attractions`,e])?.some(e=>e.id===t.attractionId)){i(_,t.attractionId);break}}catch(e){console.error(`Error cascade deleting linked attraction:`,e)}return o(e)},onSuccess:(e,t)=>{h(_,t)}});return{reservations:v,isLoading:y,error:b,createReservation:x.mutateAsync,updateReservation:S.mutateAsync,deleteReservation:C.mutateAsync,isCreating:x.isPending,isUpdating:S.isPending,isDeleting:C.isPending}}export{_ as t};